# VoxCPM 项目修改与新增功能说明文档

本文档详细说明了当前项目相对于原始 VoxCPM 开源项目所做的修改和新增功能。主要工作集中在构建高性能的生产级 API 服务、增强流式交互体验以及提供完整的测试与文档支持。

## 1. 新增核心组件

### 1.1 WebSocket/HTTP API 服务 (`api.py`)
这是本项目最大的新增模块，提供了一个基于 FastAPI 的生产级服务入口，弥补了原项目仅有命令行或简单 Gradio Demo 的不足。

*   **双协议支持**：同时支持 HTTP（适用于短音频、非实时场景）和 WebSocket（适用于实时流式场景）。
*   **流式生成 (Streaming)**：通过 WebSocket 接口 (`/ws/generate`) 实现了真正的流式音频传输，首字延迟低至 60ms 级别（纯文本模式）。
*   **辅助模型集成**：
    *   **ASR 集成 (SenseVoiceSmall)**：在 `api.py` 中集成了语音识别模型。当用户提供参考音频但未提供参考文本时，服务会自动进行语音转写，极大地简化了声音克隆的调用流程。
    *   **VAD 集成 (FSMN-VAD)**：集成了语音活动检测模型，用于处理音频切分和预处理（代码中已预留接口）。
*   **Prompt Cache 机制**：新增了 `/build_cache` 和 `/generate_with_cache` 接口，允许预先处理参考音频特征并缓存，后续生成时直接复用，显著降低了声音克隆场景下的首字延迟。
*   **健壮性设计**：实现了模型懒加载、线程锁保护、Pydantic 参数校验以及详细的错误处理。

### 1.2 性能测试套件 (`scripts/test_api_latency.py`)
为了量化评估服务性能，新增了专业的延迟测试脚本。

*   **多维度指标**：可自动计算首字延迟 (TTFB)、总耗时、音频时长和实时率 (RTF)。
*   **场景覆盖**：支持测试纯文本/声音克隆、流式/非流式等多种组合场景。
*   **可视化报告**：运行结束后直接在终端输出格式化的性能对比表格。

### 1.3 配套文档 (`docs/api使用说明文档.md`)
编写了详细的 API 接入文档，包含：
*   服务启动与部署指南。
*   HTTP 与 WebSocket 接口的完整定义（参数、返回值示例）。
*   Python 客户端调用示例代码。

## 2. 功能增强与优化

### 2.1 强制原生采样率
针对流式播放音质低沉的问题，在 API 层（`api.py`）进行了严格的逻辑控制，强制所有输出（包括流式 PCM 和非流式 WAV）统一使用模型原生的 **44100Hz** 采样率，移除了不必要的重采样逻辑，确保了最佳的音质体验。

### 2.2 声音克隆体验优化
*   **自动降噪**：API 默认开启降噪选项 (`denoise=True`)，利用 DeepFilterNet 对参考音频进行增强，提升克隆后的声音纯净度。
*   **灵活的参数控制**：开放了 `cfg_value`（控制相似度与稳定性的平衡）、`inference_timesteps`（控制生成质量与速度）等高阶参数供客户端调整。

## 3. 文件结构变动概览

相对于原仓库，主要变动如下：

```text
VoxCPM/
├── api.py                      # [新增] 核心 API 服务入口
├── docs/
│   └── api使用说明文档.md        # [新增] API 详细使用指南
├── scripts/
│   └── test_api_latency.py     # [新增] 延迟与性能测试脚本
└── ... (原项目文件)
```

## 4. 总结

本项目在 VoxCPM 强大的语音合成能力基础上，通过添加 `api.py` 服务层，将其从一个单纯的算法仓库转化为了一个可直接用于生产环境的语音合成服务。特别是**流式输出**和**自动 ASR 转写**功能的加入，极大地提升了其实时交互能力和易用性。
